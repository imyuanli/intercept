



# 抓包工具介绍

抓包（packet capture）就是将网络传输发送与接收的数据包进行截获、重发、编辑、转存等操作，也用来检查网络安全。抓包也经常被用来进行数据截取等

## 作用

前端相当一部分报错是网络错误或数据不符合预期导致的

通过拦截 http 请求,查看具体的请求信息和数据，能获取很多有用的信息，可以在一定程度上帮助 debug。

## 使用场景

接口挂了需要临时mock或者想要修改返回数据、开发移动端需要进行真机预览

## 常用抓包工具

常用的抓包工具有Charles、Fiddler、whistle

Fiddler是以代理web服务器的形式工作的，它使用代理地址:127.0.0.1，端口:8888。当启动fiddler，程序将会把自己作为一个代理，所有的http请求在达到目标服务器之前都会经过fiddler，同样的，所有的http响应都会在返回客户端之前流经fiddler，fiddler的视图是按照时间倒叙排的。

![desc](./imgs/Snipaste_2022-07-26_11-17-17.png)

Charles抓包工具也是比较常用的，和fiddler差不多，Charles请求接口和返回数据的显示方式是树状结构比较清晰。

![desc](./imgs/Snipaste_2022-07-26_11-19-03.png)

Whistle 是基于 Node 实现的跨平台抓包调试工具，最大的特点就是没有客户端，直接通过浏览器查看抓包、修改请求，而且使用方法比较简单

![desc](./imgs/Snipaste_2022-07-26_11-24-02.png)

## 使用方法

这里主要介绍Charles和Whistle的常见使用方法

### Charles

Charles 是一款强大的抓包工具，可以截取包括 https 在内的各种网络请求并方便的查看具体信息，有 Mac、Windows 和 Linux多版本，并且通过配置 WIFI 代理，也可以拦截手机发出的请求

#### 介绍

**请求查看方式**

Charles 主要提供两种查看封包的视图，分别名为 “Structure” 和 “Sequence”，分别将网络请求按访问的域名分类，以及将网络请求按访问的时间排序

![desc](./imgs/Snipaste_2022-07-26_11-40-33.png)

**菜单**

**Proxy菜单**

![desc](./imgs/d629bf8d-7e29-4d54-aea7-5f6148869463-10990593.jpg)

**Tools菜单**

![desc](./imgs/28a52d7d-9ca0-40f8-8bf5-d4be76180c59-10990593.jpg)

#### 用法

**将Charles设置成系统代理**

Charles 是通过将自己设置成代理服务器来完成抓包的，勾选系统代理后，系统本地发出去的请求都能被截取下来。

![desc](./imgs/66c80d3f-99fb-44ac-83cc-d733f3664ce6-10990593.jpg)

这一选项控制的其实是操作系统的代理设置

![desc](./imgs/Snipaste_2022-07-26_11-48-07.png)

**代理转发：Map Remote**

将某个请求地址映射到另一个远端地址，相当于修改了请求地址

![desc](./imgs/4114367b-9608-4acf-8b08-70379d5321f5-10990593.jpg)

**本地资源映射: Map Local**

本地资源映射，将请求代理到本地文件。

![desc](./imgs/Snipaste_2022-07-26_11-51-58.png)

**弱网设置**

![desc](./imgs/70fc8e0e-a7d7-4fb5-bcca-d45338238bcc-3219105.jpg)

- 配置参数解析：

  - bandwidth —— 带宽，即上行、下行数据传输速度

  - utilisation —— 带宽可用率，大部分modern是100%

  - round-trip latency —— 第一个请求的时延，单位是ms

  - MTU —— 最大传输单元，即TCP包的最大size，可以更真实模拟TCP层，每次传输的分包情况

  - Releability —— 指连接的可靠性。这里指的是10kb的可靠率。用于模拟网络不稳定

  - Stability —— 连接稳定性，也会影响带宽可用性。用于模拟移动网络，移动网络连接一般不可靠

![desc](C:/Users/jiazhouyuan/AppData/Roaming/Typora/typora-user-images/image-20220726115355924.png)

**手机代理**

通过手机wifi设置代理为PC机IP实现代理

![desc](./imgs/image-20220726115758450.png)



### whistle 

安装简单：npm i -g whistle && w2 start --init

上述命令会先全局安装 Whistle 的 npm 包后，启动 Whistle 并设置系统全局代理，以及安装系统根证书，安装成功后，用浏览器打开链接 [http://local.whistlejs.com](http://local.whistlejs.com/) 即可看到 Whistle 的抓包配置界面

#### 配置规则

视图控制台切到 Rules 并点击 Create 新建一条规则:

![desc](./imgs/5f48ab6d-f2ad-4a03-9b37-4b8282d88195-3219105.jpg)

# 抓包原理

## 中间人攻击

中间人攻击(Man-in-the-MiddleAttack，简称“MITM攻击”)，攻击者与通讯的两端分别创建独立的联系，并交换其所收到的数据，使通讯的两端认为他们正在通过一个私密的连接与对方直接对话，但事实上整个会话都被攻击者完全控制

![desc](./imgs/2f6ed105-8d32-43f2-b392-76e757998642-3219105.jpg)

**非对称加密（分为加密的公钥，解密的私钥）**

非对称加密是将加密密钥和解密密钥分开，公钥用于加密，私钥用于解密，通信过程中只把公钥传送给对方，然后对方开始给我发送加密的数据，回传的数据用私钥进行解密

在实际应用中，非对称性加密的运算速度要比对称性加密慢很多的，所以传输大量数据时，一般不会用公钥直接加密数据，而是加密对称性加密的密钥，传输给对方，然后双方使用对称性加密算法传输数据（造成中间人攻击隐患）

- 比如 Hack 拦截 B 发出的公钥，然后冒充 B 的身份给 A 发送自己的公钥，那么不知情的 A 就会把私密数据用 Hack 的公钥加密，Hack 可以通过私钥解密窃取

**数字签名**

私钥并非只能用于解密也可用用来加密数据的，对于 RSA 算法，私钥加密的数据只有公钥才能解开，数字签名就是利用了非对称性密钥的特性，将公钥加密完全颠倒过来：仍然公布公钥，但是用私钥加密数据，然后把加密的数据公布出去，这就是数字签名

数字签名的作用不是保证数据的机密性，而是证明身份，证明这些数据确实是由你本人发出的（私钥加密的数据，只有公钥才能解开，那么如果一份加密数据能够被公钥解开，这就说明这份数据是你（私钥持有者）本人发布）

- 具体流程：

  - 1、B生成公钥和私钥，然后把公钥公布出去，私钥自己保留

  - 2、用私钥加密数据作为签名，然后将数据附带着签名一同发布出去

  - 3、A收到数据和签名，需要检查此份数据是否是 B所发出，于是用 B之前发出的公钥尝试解密签名，将收到的数据和签名解密后的结果作对比，如果完全相同，说明数据没被篡改，且确实由 B发出。

  - 身份证明原因：

    - 1、如果有人修改了数据，那么 A解密签名之后，对比发现二者不一致，察觉出异常。

    - 2、如果有人替换了签名，那么 A用 B的公钥只能解出一串乱码，显然和数据不一致。

数字签名可以一定程度上认证数据的来源，这种方式依然可能受到中间人攻击，一旦涉及公钥的发布，接收方就可能收到中间人的假公钥，进行错误的认证，这个问题始终避免不了

要想确定对方的身份，必须有一个信任的源头，即**公钥证书**

证书其实就是 公钥 + 签名，由第三方认证机构颁发，引入可信任的第三方，是终结信任循环的一种可行方案

- 证书认证的流程大致如下：

  - 1、B 去可信任的认证机构证实本人真实身份，并提供自己的公钥。

  - 2、A想跟 B通信，首先向认证机构请求 B的公钥，认证机构会把一张证书（B的公钥以及机构对其公钥的签名）发送给 A。

  - 3、A 检查签名，确定该公钥确实由这家认证机构发送，中途未被篡改。

  - 4、A 通过这个公钥加密数据，开始和 B通信。

正规浏览器中都预存了正规认证机构的证书（包含其公钥），用于确认机构身份，所以说证书的认证是可信的

- 现在的正规网站，大都使用 HTTPS 协议

  - HTTPS 协议就是在 HTTP 协议和 TCP 协议之间加了一个 SSL/TLS 安全层。

  - 在你的浏览器和网站服务器完成 TCP 握手后，SSL 协议层也会进行 SSL 握手交换安全参数，其中就包含该网站的证书，以便浏览器验证站点身份。

  - SSL 安全层验证完成之后，上层的 HTTP 协议内容都会被加密，保证数据的安全传输



**ssl证书**

SSL 证书，也称为服务器 SSL 证书，是遵守 SSL 协议的一种数字证书，由全球信任的证书颁发机构(CA)验证服务器身份后颁发。

CA，Catificate Authority，它的作用就是提供证书（即服务器证书，由域名、公司信息、序列号和签名信息组成）加强服务端和客户端之间信息交互的安全性，以及证书运维相关服务。

**任何个体/组织都可以扮演 CA 的角色，只不过难以得到客户端的信任**，能够受浏览器默认信任的 CA 大厂商有很多，其中 TOP5 是 Symantec、Comodo、Godaddy、GolbalSign 和 Digicert。

在使用抓包工具抓取https请求前，需要先将抓包工具的证书安装到系统可信任根证书颁发机构中存储

![desc](./imgs/image-20220726121958963.png)

Charles抓包流程

![desc](./imgs/fd25a614-9f8e-47b3-8d7c-a9a86b7ee587-10990593.jpg)

## Demo：node抓包工具

